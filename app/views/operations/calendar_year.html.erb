<nav>
  <ul class="pagination">
    <li role="presentation">
      <%= link_to calendar_year_operations_path(year: params[:year].to_i-1) do%>
        &laquo; <%= params[:year].to_i-1 %>
      <% end %>
    </li>
    <li role="presentation">
      <%= link_to calendar_year_operations_path(year: params[:year].to_i+1) do%>
        <%= params[:year].to_i+1 %> &raquo;
      <% end %>
    </li>
  </ul>
</nav>
<table class="table table-striped table-bordered table-condensed table-hover">
  <thead>
    <tr>
      <th>Spese del <%= params[:year] %></th>
      <% (1..12).each do |month| %>
        <th><%= link_to month, calendar_month_operations_path(year: params[:year], month: month) %></th>
      <% end %>
      <th>Totale</th>
    </tr>
  </thead>
  <tbody>
    <%= render :partial => 'year_table', :collection => @operations_per_type, :as => :operations, locals: { sign: '-' } %>
    <%= render :partial => 'total_year_table', locals: { sign: '-', total: "Spese" } %>
    <tr>
      <th>Introiti <%= params[:year] %></th>
      <% (1..12).each do |month| %>
        <th><%= link_to month, calendar_month_operations_path(year: params[:year], month: month) %></th>
      <% end %>
      <th>Totale</th>
    </tr>
    <%= render :partial => 'year_table', :collection => @operations_per_type, :as => :operations, locals: { sign: '+' } %>
    <%= render :partial => 'total_year_table', locals: { sign: '+', total: "Introiti" } %>
    <tr>
      <th>Saldo</th>
      <% @operations_per_month.each_with_index do |operation_per_month, i| %>
        <% cache [operation_per_month.maximum(:updated_at), "saldo", params[:year], i] do %>
          <th>
            <%= number_to_currency(operation_per_month.where(sign: "+").sum(:amount) - operation_per_month.where(sign: "-").sum(:amount)) %>
          </th>
        <% end %>
      <% end %>
      <th>
        <% cache [@operations_per_month.max {|o| o.maximum(:updated_at) ? o.maximum(:updated_at) : 0}, "saldo-totale", params[:year]] do %>
          <%= number_to_currency(@operations_per_month.sum {|o| o.where(sign: "+").sum(:amount)} - @operations_per_month.sum {|o| o.where(sign: "-").sum(:amount)}) %>
        <% end %>
      </th>
    </tr>
    <tr>
      <% cache [@operations_cumulus.maximum(:updated_at), "saldo-cumulativo-totale"] do %>
        <th>Saldo Cumulativo</th>
          <% (1..12).each do |i| %>
            <th>
              <% cache [@operations_cumulus.where(month: (1..i)).maximum(:updated_at), "saldo-cumulativo", params[:year], i] do %>
                <%= number_to_currency(@operations_cumulus.where(month: (1..i), sign: "+").sum(:amount) - @operations_cumulus.where(month: (1..i), sign: "-").sum(:amount)) %>
              <% end %>
            </th>
          <% end %>
        <% cache [@operations_cumulus_prev.maximum(:updated_at), "saldo-cumulativo-totale"] do %>
          <th title="Differenza tra saldo anno corrente e anno precedente">
            <%= number_to_currency(@diff_cumulus) %>
          </th>
        <% end %>
      <% end %>
    </tr>
    <tr>
      <th>Saldo Trimestrale</th>
      <% (0..3).each do |i| %>
        <% cache [@operations_cumulus.where(month: ((i*3)+1..(i+1)*3)).maximum(:updated_at), "saldo-trimestrale", params[:year], i] do %>
          <th colspan="3" style="text-align:center;border-right:1px solid #ccc;">
            <%= number_to_currency(@operations_cumulus.where(month: ((i*3)+1..(i+1)*3), sign: "+").sum(:amount) - @operations_cumulus.where(month: ((i*3)+1..(i+1)*3), sign: "-").sum(:amount)) %>
            <% if (@operations_cumulus_prev.where(month: ((i*3)+1..(i+1)*3), sign: "+").sum(:amount) - @operations_cumulus_prev.where(month: ((i*3)+1..(i+1)*3), sign: "-").sum(:amount)) != 0 %>
              <span title="Variazione rispetto allo stesso trimestre dell'anno precedente">
                (<%= number_to_percentage((100.to_f/(@operations_cumulus_prev.where(month: ((i*3)+1..(i+1)*3), sign: "+").sum(:amount) - @operations_cumulus_prev.where(month: ((i*3)+1..(i+1)*3), sign: "-").sum(:amount))*(@operations_cumulus.where(month: ((i*3)+1..(i+1)*3), sign: "+").sum(:amount) - @operations_cumulus.where(month: ((i*3)+1..(i+1)*3), sign: "-").sum(:amount)))-100, precision: 1, strip_insignificant_zeros: true) %>)
              </span>
            <% end %>
          </th>
        <% end %>
      <% end %>
      <td></td>
    </tr>
  </tbody>
</table>
<% cache [@tot_operations_per_type.maximum(:updated_at), "yearly_charts1"] do %>
  <div class="row-fluid">
    <% { "Uscite": "-", "Entrate": "+"}.each do |k,v| %>
      <%= render partial: "tot_year_operation", locals: { sum_amount: @tot_operations_per_type.where(sign: v).sum(:amount), title: k } %>
    <% end %>
  </div>
<% end %>
