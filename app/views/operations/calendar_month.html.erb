<nav>
  <ul class="pagination">
    <li role="presentation">
      <% if params[:month].to_i > 1 %>
        <%= link_to calendar_month_operations_path(year: params[:year], month: params[:month].to_i-1) do%>
          &laquo; <%= l Date.parse("2015/"+(params[:month].to_i-1).to_s+"/01"), format: :month %>
        <% end %>
      <% else %>
        <%= link_to calendar_month_operations_path(year: params[:year].to_i-1, month: 12) do%>
          &laquo; <%= l Date.parse((params[:year].to_i-1).to_s+"/12/1"), format: :year %>
        <% end %>
      <% end %>
    </li>
    <li role="presentation">
      <% if params[:month].to_i < 12 %>
        <%= link_to calendar_month_operations_path(year: params[:year], month: params[:month].to_i+1) do%>
          <%= l Date.parse("2015/"+(params[:month].to_i+1).to_s+"/01"), format: :month %> &raquo;
        <% end %>
      <% else %>
        <%= link_to calendar_month_operations_path(year: params[:year].to_i+1, month: 1) do%>
          <%= l Date.parse((params[:year].to_i+1).to_s+"/1/1"), format: :year %> &raquo;
        <% end %>
      <% end %>
    </li>
  </ul>
</nav>
<% cache [id_and_maximum_updated_at(@operations), "calendar_month", params[:year], params[:month]] do %>
  <h1>Movimenti di <%= l Date.parse(params[:year]+"/"+params[:month]+"/1"), format: :year %>
    <br />
    <small>
      <%= link_to calendar_year_operations_path(params[:year]) do %>
        Torna al <%= params[:year] %>
      <% end %>
    </small>
  </h1>

  <table class="table">
    <thead>
      <tr>
        <th>Type</th>
        <th>Subtotal</th>
        <th>Day</th>
        <th>User</th>
        <th>Amount</th>
        <th>Note</th>
        <th colspan="3"></th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th colspan="9">Uscite</th>
      </tr>
      <% @types.each do |type| %>
        <%= render :partial => 'month_table', locals: { operations: @operations_per_type.where(type_id: type.id), sign: "-", month: params[:month], year: params[:year] } %>
      <% end %>
      <tr>
        <th colspan="3">Totale Uscite</th>
        <th colspan="2"><%= number_to_currency(@operations_per_type.where(sign: "-").sum('amount')) %></th>
        <th colspan="4"></th>
      </tr>
      <tr>
        <th colspan="9">Entrate</th>
      </tr>
      <% @types.each do |type| %>
        <%= render :partial => 'month_table', locals: { operations: @operations_per_type.where(type_id: type.id), sign: "+", month: params[:month], year: params[:year] } %>
      <% end %>
      <tr>
        <th colspan="3">Totale Entrate</th>
        <th colspan="2"><%= number_to_currency(@operations_per_type.where(sign: "+").sum('amount')) %></th>
        <th colspan="4"></th>
      </tr>
      <tr>
        <th colspan="3">Saldo</th>
        <th colspan="2">
          <%= number_to_currency(@operations_per_type.where(sign: "+").sum('amount') - @operations_per_type.where(sign: "-").sum('amount')) %>
        </th>
        <th colspan="4"></th>
      </tr>
    </tbody>
  </table>
  <% User.all.each do |user| %>
    <%= render partial: "pie_chart_per_user", locals: { user: user, tot_operations_per_type: @tot_operations_per_type, operations_per_type: @operations_per_type, interval: "#{params[:year]}#{params[:month]}" } %>
  <% end %>
  <%= render partial: "pie_chart_total", locals: { tot_operations_per_type: @tot_operations_per_type, operations_per_type: @operations_per_type, interval: "#{params[:year]}#{params[:month]}" } %>
<% end %>
